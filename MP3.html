<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV搜索工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // Tailwind配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-soft sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-4 md:mb-0">
                <i class="fa fa-music mr-2"></i>MV搜索工具
            </h1>
            <div class="text-sm text-gray-500 text-center md:text-right">
                <p>全网MV资源 · 在线试听 · 高清下载</p>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 工具说明 -->
        <section class="bg-white rounded-lg shadow-soft p-6 mb-8">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">工具说明</h2>
            <p class="text-gray-600 leading-relaxed">
                欢迎使用MV搜索工具！本工具支持全网MV搜索，可在线试听及下载。
                <br>使用方法：在上方搜索框输入歌曲名，点击搜索按钮或按回车键即可。
                <br>示例：输入"晴天"、"海阔天空"等歌曲名进行搜索
            </p>
        </section>

        <!-- 搜索区域 -->
        <section class="mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="请输入歌曲名搜索MV..." 
                    class="flex-grow px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-custom"
                >
                <button 
                    id="searchBtn" 
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-custom flex items-center justify-center"
                >
                    <i class="fa fa-search mr-2"></i>搜索
                </button>
            </div>

            <!-- 分类推荐 - 已移除"随便听听"按钮 -->
            <div class="mt-6 bg-white rounded-lg shadow-soft p-4">
                <h3 class="text-md font-medium mb-3 text-gray-700">随便听听</h3>
                <div class="flex flex-wrap gap-2">
                    <button class="category-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm transition-custom" data-key="周杰伦">周杰伦</button>
                    <button class="category-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm transition-custom" data-key="经典">经典</button>
                    <button class="category-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm transition-custom" data-key="DJ">DJ</button>
                    <button class="category-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm transition-custom" data-key="邓紫棋">邓紫棋</button>
                </div>
            </div>
        </section>

        <!-- 加载状态 -->
        <div id="loading" class="hidden flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-8"></div>

        <!-- 播放区域 -->
        <section id="playerSection" class="hidden bg-white rounded-lg shadow-soft p-6 mb-8">
            <div class="flex flex-col md md:flex-row gap-6">
                <!-- 封面和信息 -->
                <div class="md:w-1/3">
                    <div class="relative rounded-lg overflow-hidden mb-4 aspect-video bg-gray-200">
                        <img id="coverImage" src="" alt="封面" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h3 id="currentTitle" class="text-xl font-bold text-gray-800 mb-1"></h3>
                        <p class="text-gray-600 mb-4">
                            歌手：<a id="singerLink" href="#" class="text-primary hover:underline"></a>
                        </p>
                         
                    </div>
                </div>

                <!-- 视频播放 -->
                <div class="md:w-2/3">
                    <video 
                        id="mvPlayer" 
                        class="w-full rounded-lg shadow-md" 
                        controls autoplay playsinline
                    ></video>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>提示：视频加载需要时间，请耐心等待。播放完毕将自动播放下一首。</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 结果列表 -->
        <section id="resultSection" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-list-ul mr-2 text-primary"></i>搜索结果
                <span id="resultCount" class="ml-2 text-sm font-normal text-gray-500"></span>
            </h2>
            <div id="resultList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- 结果项将通过JS动态生成 -->
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>© 2025 MV搜索工具 | 数据来源：慕名API</p>
            <p class="mt-2 text-gray-400">使用本工具请遵守相关法律法规，支持正版音乐</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let currentSearchKey = '';
        let currentSongIndex = 0;
        let songList = [];
        let currentQualityUrls = [];

        // DOM元素
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const categoryBtns = document.querySelectorAll('.category-btn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const playerSection = document.getElementById('playerSection');
        const resultSection = document.getElementById('resultSection');
        const resultList = document.getElementById('resultList');
        const resultCount = document.getElementById('resultCount');
        const mvPlayer = document.getElementById('mvPlayer');
        const coverImage = document.getElementById('coverImage');
        const currentTitle = document.getElementById('currentTitle');
        const singerLink = document.getElementById('singerLink');
        const downloadBtn = document.getElementById('downloadBtn');

        // 初始化事件监听
        function initEventListeners() {
            // 搜索按钮点击
            searchBtn.addEventListener('click', () => {
                const key = searchInput.value.trim();
                if (key) {
                    searchMV(key);
                } else {
                    showError('请输入歌曲名后再搜索');
                }
            });

            // 回车键搜索
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });

            // 分类按钮点击
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.dataset.key;
                    searchInput.value = key;
                    searchMV(key);
                });
            });

            // 歌手链接点击（搜索该歌手）
            singerLink.addEventListener('click', (e) => {
                e.preventDefault();
                const singerName = singerLink.textContent.trim();
                searchInput.value = singerName;
                searchMV(singerName);
            });

            // 视频播放完毕自动下一首
            mvPlayer.addEventListener('ended', playNextSong);

            // 下载按钮点击
            downloadBtn.addEventListener('click', downloadMV);
        }

        // 搜索MV
        async function searchMV(keyword) {
            // 重置状态
            resetState();
            // 显示加载
            showLoading(true);
            
            try {
                currentSearchKey = keyword;
                const encodedKey = encodeURIComponent(keyword);
                const apiUrl = `https://api.suol.cc/v1/mv.php?msg=${encodedKey}`;
                
                // 调用API获取列表
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.code === 200 && data.list && data.list.length > 0) {
                    songList = data.list;
                    // 显示结果数量
                    resultCount.textContent = `（共 ${songList.length} 个结果）`;
                    // 生成结果列表
                    renderResultList();
                    // 显示结果区域
                    resultSection.classList.remove('hidden');
                    // 自动播放第一首
                    if (songList.length > 0) {
                        playSong(0);
                    }
                } else {
                    showError('未找到相关MV资源，请尝试其他关键词');
                }
            } catch (err) {
                console.error('搜索失败:', err);
                showError('搜索失败，请检查网络连接或稍后再试');
            } finally {
                // 隐藏加载
                showLoading(false);
            }
        }

        // 渲染结果列表
        function renderResultList() {
            resultList.innerHTML = '';
            
            songList.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = `bg-white rounded-lg shadow-soft p-4 hover:shadow-md transition-custom cursor-pointer ${index === currentSongIndex ? 'border-2 border-primary' : 'border border-transparent'}`;
                songItem.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-12 h-12 rounded bg-gray-200 flex items-center justify-center flex-shrink-0">
                            <i class="fa fa-music text-primary text-xl"></i>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-medium text-gray-800 line-clamp-1">${song.name}</h3>
                            <p class="text-sm text-gray-500 mt-1">${song.singer || '未知歌手'}</p>
                            <div class="mt-2 flex items-center text-xs text-gray-400">
                                <span>点击播放</span>
                                ${index === currentSongIndex ? '<span class="ml-2 px-2 py-0.5 bg-primary/10 text-primary rounded">正在播放</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // 点击列表项播放对应歌曲
                songItem.addEventListener('click', () => {
                    playSong(index);
                });
                
                resultList.appendChild(songItem);
            });
        }

        // 播放指定索引的歌曲
        async function playSong(index) {
            if (index < 0 || index >= songList.length) return;
            
            // 更新当前索引
            currentSongIndex = index;
            // 更新列表选中状态
            renderResultList();
            
            // 显示加载
            showLoading(true);
            
            try {
                const song = songList[index];
                const encodedKey = encodeURIComponent(currentSearchKey);
                const apiUrl = `https://api.suol.cc/v1/mv.php?msg=${encodedKey}&n=${index + 1}`;
                
                // 调用API获取歌曲详情
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.code === 200 && data.url && data.url.length > 0) {
                    // 保存当前质量URL列表
                    currentQualityUrls = data.url;
                    
                    // 更新播放区域信息
                    updatePlayerInfo(data);
                    
                    // 设置最高质量播放（最后一个URL）
                    const highestQualityUrl = data.url[data.url.length - 1];
                    mvPlayer.src = highestQualityUrl;
                    
                    // 显示播放区域
                    playerSection.classList.remove('hidden');
                } else {
                    showError('无法获取该MV的播放资源');
                }
            } catch (err) {
                console.error('获取播放资源失败:', err);
                showError('获取播放资源失败，请稍后再试');
            } finally {
                // 隐藏加载
                showLoading(false);
            }
        }

        // 更新播放器信息
        function updatePlayerInfo(data) {
            // 更新封面（如果有）
            if (data.cover) {
                coverImage.src = data.cover;
                coverImage.alt = `${data.name} - ${data.singer} 封面`;
            } else {
                coverImage.src = 'https://picsum.photos/400/225?music';
                coverImage.alt = '默认封面';
            }
            
            // 更新标题和歌手
            currentTitle.textContent = data.name || '未知歌曲';
            singerLink.textContent = data.singer || '未知歌手';
        }

        // 播放下一首
        function playNextSong() {
            let nextIndex = currentSongIndex + 1;
            // 如果是最后一首，回到第一首
            if (nextIndex >= songList.length) {
                nextIndex = 0;
            }
            playSong(nextIndex);
        }

        // 下载MV - 修复下载功能，确保弹出保存对话框
        function downloadMV() {
            if (currentQualityUrls.length === 0) {
                showError('无法获取下载资源');
                return;
            }
            
            // 获取最高质量URL
            const highestQualityUrl = currentQualityUrls[currentQualityUrls.length - 1];
            // 获取当前歌曲信息
            const currentSong = songList[currentSongIndex];
            const songName = currentSong.name || '未知歌曲';
            const singerName = currentSong.singer || '未知歌手';
            
            // 提取文件格式（默认MP4）
            let fileExt = 'mp4';
            if (highestQualityUrl.includes('.mp4')) {
                fileExt = 'mp4';
            } else if (highestQualityUrl.includes('.mkv')) {
                fileExt = 'mkv';
            } else if (highestQualityUrl.includes('.flv')) {
                fileExt = 'flv';
            }
            
            // 生成文件名
            const fileName = `${singerName} - ${songName}.${fileExt}`;
            
            // 修复下载功能：使用fetch获取资源并转换为blob
            fetch(highestQualityUrl)
                .then(response => response.blob())
                .then(blob => {
                    // 创建blob URL
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // 创建下载链接
                    const downloadLink = document.createElement('a');
                    downloadLink.href = blobUrl;
                    downloadLink.download = fileName;
                    
                    // 触发下载
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                    
                    // 显示提示
                    showError(`开始下载：${fileName}`, 'success');
                })
                .catch(error => {
                    console.error('下载失败:', error);
                    showError('下载失败，请尝试再次下载');
                });
        }

        // 显示/隐藏加载状态
        function showLoading(show) {
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // 显示错误提示
        function showError(message, type = 'error') {
            error.textContent = message;
            error.classList.remove('hidden');
            
            // 设置样式
            if (type === 'success') {
                error.className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-8';
            } else {
                error.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-8';
            }
            
            // 3秒后自动隐藏
            setTimeout(() => {
                error.classList.add('hidden');
            }, 3000);
        }

        // 重置状态
        function resetState() {
            // 隐藏错误、播放区、结果区
            error.classList.add('hidden');
            playerSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            // 清空列表
            resultList.innerHTML = '';
            // 重置视频
            mvPlayer.src = '';
            // 重置变量
            songList = [];
            currentSongIndex = 0;
            currentQualityUrls = [];
        }

        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            // 默认聚焦搜索框
            searchInput.focus();
        });
    </script>
</body>
</html>
